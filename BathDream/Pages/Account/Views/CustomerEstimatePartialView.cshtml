@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@using BathDream.Models
@model BathDream.Pages.Account.CustomerModel.InputModel
@{
}

<br />
@if (Model.Display)
{
    string sub_caption = "";
    <form id="formWork" method="post">
        <div class="col-xs-12" style="padding: 5px">

            <div class="col-xs-6">
                <img alt="Brand" src="~/img/logo.png">

            </div>
            <div class="col-xs-6" style="text-align:left">
                <p>
                    <b>
                        Приложение № 1<br />
                        К договору № @Model.OrderNumber от @Model.OrderDate<br />
                        Адрес объекта: @Model.OrderAddress<br />
                        Сметный расчет: @Model.OrderNumber
                    </b>
                </p>

            </div>

            <hr class="col-xs-12" />

            <div class="col-xs-12" style="text-align:center">
                <p><span style="font-size: xx-large;">Смета</span><br /><b>на выполнение ремонтно-отдельчных работ</b></p>


            </div>

            <p style="text-align:center">Помещения</p>

            <div class="table-responsive">
                <table class="table table-bordered table-hover table-condensed">
                    <tr class="success">
                        <th>Помещение</th>
                        @foreach (Room room in @Model.Rooms)
                        {
                            <th style="text-align: center;">@room.Name</th>
                        }
                    </tr>
                    <tr>
                        <td>Размеры</td>
                        @foreach (Room room in @Model.Rooms)
                        {
                            <td style="text-align: center;">@room.Width x @room.Length x @room.Height мм</td>
                        }
                    </tr>
                    <tr>
                        <td>Пол</td>
                        @foreach (Room room in @Model.Rooms)
                        {
                            <td style="text-align: center;">@room.FloorArea() кв.м</td>
                        }
                    </tr>
                    <tr>
                        <td>Стены</td>
                        @foreach (Room room in @Model.Rooms)
                        {
                            <td style="text-align: center;">@room.WallsArea() кв.м</td>
                        }
                    </tr>
                    <tr>
                        <td>Потолок</td>
                        @foreach (Room room in @Model.Rooms)
                        {
                            <td style="text-align: center;">@room.CeilingArea() кв.м</td>
                        }
                    </tr>
                    <tr>
                        <td>Дверь</td>
                        @foreach (Room room in @Model.Rooms)
                        {
                            <td style="text-align: center;">@room.DoorArea() кв.м</td>
                        }
                    </tr>
                    <tr></tr>
                </table>
            </div>


            <p style="text-align:center">Работы</p>
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-condensed">
                    <tr class="success">
                        <th style="text-align: center;">№ п/п</th>
                        <th style="text-align: center;">Тип</th>
                        <th style="text-align: center;">Наименование</th>
                        <th style="text-align: center;">Ед.изм</th>
                        <th style="text-align: center;">Цена</th>
                        <th style="text-align: center;">Кол-во</th>
                        <th style="text-align: center;">Сумма</th>
                        @if (!Model.Signed)
                        {
                            <th></th>
                            <th></th>
                        }
                    </tr>

                    @foreach (Work work in @Model.Works)
                    {
                        string workId = work.Id.ToString();

                        string rowId = "row" + workId;

                        string spanId = "span" + workId;
                        string inputId = "input" + workId;
                        string editBtnId = "editBtn" + workId;
                        string submitBtnId = "submitBtn" + workId;
                        string okBtnId = "okBtn" + workId;
                        string cancelBtnId = "cancelBtn" + workId;
                        string totalRowId = "totalRow" + workId;

                        if (sub_caption != work.Group)
                        {
                            sub_caption = work.Group;
                            @if (!Model.Signed)
                            {
                                <tr id="@work.Group">
                                    <td colspan="9" class="info" style="text-align: center;"><b>@sub_caption</b></td>
                                </tr>
                            }
                            else
                            {
                                <tr id="@work.Group">
                                    <td colspan="8" class="info" style="text-align: center;"><b>@sub_caption</b></td>
                                </tr>
                            }

                        }
                        <tr id="@rowId">
                            <td style="text-align: center;">@work.Position</td>
                            <td>@work.FirstWord</td>
                            <td>@work.WithoutFirstWord</td>
                            <td style="text-align: center;">@work.Unit</td>
                            <td style="text-align: right;">
                                @if (work.Price == 0.0)
                                {<span>30% от стоимости</span> }
                                else
                                    @work.Price.ToString("# ##0")
                            </td>
                            <td style="text-align: center;">
                                <span id="@spanId">@work.Volume </span> 
                                <input id="@inputId" type="hidden"/>
                            </td>
                            <td style="text-align: right;">
                                <span id="@totalRowId">@work.Total.ToString("# ##0.00")</span>
                            </td>
                            @if (!Model.Signed)
                            {
                                <td>
                                    @*<a data-toggle="modal" data-target="#deleteModal" data-name="@work.Id"><i class="fas fa-times"></i></a>*@
                                    <a id="@editBtnId" name="@work.Id" onclick="ShowEdit(this)"><i class="fas fa-edit"></i></a>
                                    <button id="@okBtnId" name="@work.Id" onclick="EditWork(this)" style="background: transparent; border: 0;" hidden><i class="fas fa-check"></i></button>
                                </td>
                                <td>
                                    <button id="@submitBtnId" name="@work.Id" onclick="DeleteWork(this)" style="background: transparent; border: 0;"><i class="fas fa-trash-alt"></i></button>
                                    <a id="@cancelBtnId" name="@work.Id" onclick="CancelEdit(this)" hidden><i class="fas fa-times"></i></a>
                                </td>
                            }
                        </tr>
                    }
                </table>

                

                @*<div aria-hidden="true" class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="myModalLabel" role="dialog">
                    <div class="modal-dialog modal-sm" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title" id="myModalLabel">Вы уверены?</h4>
                            </div>
                            <div class="modal-footer">
                                <a class="btn btn-primary" data-dismiss="modal">Закрыть</a>
                                <input type="submit" onclick="DeleteWork(this)" class="btn btn-primary" name="" value="Удалить" />
                            </div>
                        </div>
                    </div>
                </div>*@

                @*asp-page-handler="DeleteWork" asp-route-workid="@work.Id" *@
            </div>
            <h2 style="text-align: right;">Итого: <span id="totalAll">@Model.Total.ToString("# ##0.00")</span></h2>
        </div>
        <p style="text-align:center"><span style="font-size: large;">График работ</span></p>
        <div class="table-responsive">
            @{
                int totalTime = Model.UniqueWorks.Sum(w => w.WorkType.Time);
                int count = 0;
            }
            <table class="table table-bordered table-hover table-condensed">
                <tr>
                    <th>
                        Наименование работ
                    </th>
                    @for (int i = 1; i <= totalTime; i++)
                    {
                        <th>
                            @i-й день
                        </th>
                    }
                </tr>
                @foreach (var item in Model.UniqueWorks)
                {
                    <tr>
                        <td>@item.WorkType.Name</td>
                        @for (int i = 0; i < count; i++)
                        {
                            <td></td>
                        }
                        <td colspan="@item.WorkType.Time" style="background: #263e44;"></td>
                        @for (int i = 0; i < totalTime - item.WorkType.Time - count; i++)
                        {
                            <td></td>
                        }
                        @{
                            count += item.WorkType.Time;
                        }
                    </tr>
                }
            </table>
        </div>
    </form>
}

<script>
    $('#deleteModal').on('show.bs.modal', function (event) {
        var a = $(event.relatedTarget); // Кнопка, запускающая модальное окно
        var workId = a.data('name'); // Извлечь информацию из атрибутов data- *
        // При необходимости Вы можете инициировать здесь запрос AJAX (а затем выполнить обновление в обратном вызове).
        // Обновите содержимое модального окна. Здесь мы будем использовать jQuery, но вместо этого Вы можете использовать библиотеку привязки данных или другие методы.
        var modal = $(this);
        modal.find('.modal-footer input').attr('name', workId);
    });

    var span;
    var input;
    var editBtn;
    var submitBtn;
    var okBtn;
    var cancelBtn;

    function ShowEdit(e) {

        span = document.getElementById('span' + e.name);
        input = document.getElementById('input' + e.name);
        editBtn = document.getElementById('editBtn' + e.name);
        submitBtn = document.getElementById('submitBtn' + e.name);
        okBtn = document.getElementById('okBtn' + e.name);
        cancelBtn = document.getElementById('cancelBtn' + e.name);

        span.hidden = true;

        input.type = "text";
        input.value = span.innerText;

        editBtn.hidden = true;
        submitBtn.hidden = true;

        okBtn.hidden = false;
        cancelBtn.hidden = false;
    }

    function CancelEdit(e) {

        span = document.getElementById('span' + e.name);
        input = document.getElementById('input' + e.name);
        editBtn = document.getElementById('editBtn' + e.name);
        submitBtn = document.getElementById('submitBtn' + e.name);
        okBtn = document.getElementById('okBtn' + e.name);
        cancelBtn = document.getElementById('cancelBtn' + e.name);

        span.hidden = false;

        input.type = "hidden";
        input.value = span.innerText;

        editBtn.hidden = false;
        submitBtn.hidden = false;

        okBtn.hidden = true;
        cancelBtn.hidden = true;


    }

   

</script>